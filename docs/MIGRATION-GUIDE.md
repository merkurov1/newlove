# üõ°Ô∏è BULLETPROOF DATABASE MIGRATION SYSTEM

**–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞–¥—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Å Prisma + Supabase + Vercel**

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π  
‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - —Ç–∞–π–º–∞—É—Ç—ã –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –º–∏–Ω–∏–º—É–º —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π  

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```bash
npm run db:status      # –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
npm run db:validate    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
npm run db:create add_user_bio    # –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npm run db:deploy                 # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```

### 3. –ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å
```bash
npm run db:workflow add_new_feature    # –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π
npm run db:workflow                    # –¢–æ–ª—å–∫–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
```

---

## üìã –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å |
|---------|----------|--------------|
| `npm run db:status` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π | ‚úÖ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ |
| `npm run db:validate` | –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É Prisma | ‚úÖ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ |
| `npm run db:generate` | –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| `npm run db:create <name>` | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é | ‚ö†Ô∏è –°–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª—ã |
| `npm run db:deploy` | –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ | üî• –ò–∑–º–µ–Ω—è–µ—Ç –ë–î |
| `npm run db:backup` | –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø | ‚úÖ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ |
| `npm run db:workflow [name]` | –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å | üî• –ò–∑–º–µ–Ω—è–µ—Ç –ë–î |
| `npm run db:help` | –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É | ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è |

---

## üîÑ –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

### üü¢ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (Development)

1. **–ò–∑–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É** –≤ `prisma/schema.prisma`
2. **–°–æ–∑–¥–∞—ë–º –º–∏–≥—Ä–∞—Ü–∏—é**:
   ```bash
   npm run db:create add_user_preferences
   ```
3. **–ü—Ä–æ–≤–µ—Ä—è–µ–º SQL —Ñ–∞–π–ª** –≤ `prisma/migrations/`
4. **–ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ**:
   ```bash
   npm run db:deploy
   ```

### üîµ –î–µ–ø–ª–æ–π –Ω–∞ Vercel (Production)

1. **Push –≤ main** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `vercel-build`
2. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `npm run db:deploy`
3. **Rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Vercel

### üü° –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏

#### –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞:
```bash
# –ü—Ä–µ—Ä–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
npm run db:status     # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
npm run db:backup     # –°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø
npm run db:deploy     # –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
```

#### –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –æ—Ç–∫–∞—Ç:
```bash
# –û—Ç–∫–∞—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ schema.prisma
git checkout HEAD~1 -- prisma/schema.prisma
npm run db:workflow   # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```

---

## üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
- **–°—Ö–µ–º–∞ Prisma** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `./backups/schema-backup-*.prisma`
- **SQL –¥–∞–º–ø** —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ `./backups/db-backup-*.sql` (–µ—Å–ª–∏ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞)
- **Retention**: –±—ç–∫–∞–ø—ã —Ö—Ä–∞–Ω—è—Ç—Å—è 30 –¥–Ω–µ–π

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- ‚úÖ GitHub Actions –ø—Ä–æ–≤–µ—Ä—è—é—Ç PR –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- üìä –õ–æ–≥–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —á–µ—Ä–µ–∑ Sentry
- üìà –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.local)
```bash
DATABASE_URL="postgresql://user:pass@host:port/db"
NEXTAUTH_SECRET="your-secret"
SUPABASE_URL="https://your-project.supabase.co"
SUPABASE_SERVICE_ROLE_KEY="your-service-key"
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤ (.env.migration)
```bash
MIGRATION_TIMEOUT=30000          # 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
MIGRATION_DB_TIMEOUT=60000       # 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ë–î –æ–ø–µ—Ä–∞—Ü–∏–∏
MIGRATION_MAX_RETRIES=3          # –ú–∞–∫—Å–∏–º—É–º –ø–æ–≤—Ç–æ—Ä–æ–≤
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Database connection timeout"
```bash
# –†–µ—à–µ–Ω–∏–µ:
npm run db:status     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î
npm run db:validate   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Migration already applied"
```bash
# –†–µ—à–µ–Ω–∏–µ:
npm run db:status     # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å
# –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Schema validation failed"
```bash
# –†–µ—à–µ–Ω–∏–µ:
npm run db:validate   # –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å schema.prisma
npm run db:generate   # –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç
```

---

## üìö Best Practices

### ‚úÖ DO (–î–µ–ª–∞–π—Ç–µ)
- –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ SQL —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏–π
- –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

### ‚ùå DON'T (–ù–µ –¥–µ–ª–∞–π—Ç–µ)  
- –ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å—Ö–µ–º—ã
- –ù–µ –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –±—ç–∫–∞–ø–∞
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ generic –∏–º–µ–Ω–∞ —Ç–∏–ø–∞ "update"
- –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏

---

## üéØ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
```sql
-- –•–æ—Ä–æ—à–æ: nullable –ø–æ–ª–µ
ALTER TABLE "User" ADD COLUMN "bio" TEXT;

-- –ü–ª–æ—Ö–æ: not null –±–µ–∑ default
ALTER TABLE "User" ADD COLUMN "required_field" TEXT NOT NULL;
```

### –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è (–æ–ø–∞—Å–Ω–æ)
```sql
-- 1. –°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ –ø–æ–ª–µ nullable
ALTER TABLE "User" ALTER COLUMN "old_field" DROP NOT NULL;

-- 2. –í —Å–ª–µ–¥—É—é—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–∏—Ç–µ
ALTER TABLE "User" DROP COLUMN "old_field";
```

### –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–æ—á–µ–Ω—å –æ–ø–∞—Å–Ω–æ)
```sql
-- 1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE "NewUsers" AS SELECT * FROM "User";

-- 2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
-- 3. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É –≤ —Å–ª–µ–¥—É—é—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
```

---

## üöÄ CI/CD Integration

### GitHub Actions
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è PR
- –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ –ø—Ä–∏ push
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã –Ω–∞ –∫–∞–∂–¥—ã–π –∫–æ–º–º–∏—Ç

### Vercel Deployment
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
- Fallback –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**: `npm run db:status`
2. **–°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø**: `npm run db:backup`  
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ö–µ–º—É**: `npm run db:validate`
4. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø–æ–º–æ—â—å—é** —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏

**–ü–æ–º–Ω–∏—Ç–µ**: –õ—É—á—à–µ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å 5 –º–∏–Ω—É—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É, —á–µ–º 5 —á–∞—Å–æ–≤ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö! üõ°Ô∏è