#!/bin/bash

# üöÄ VERCEL DEPLOYMENT MIGRATION SCRIPT
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ Vercel

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ –ù–ê–ß–ò–ù–ê–ï–ú DEPLOYMENT –ú–ò–ì–†–ê–¶–ò–ô"
echo "================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏
if [ "$VERCEL_ENV" = "production" ]; then
    echo "üéØ Production deployment –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ DATABASE_URL
    if [ -z "$DATABASE_URL" ]; then
        echo "‚ùå –û–®–ò–ë–ö–ê: DATABASE_URL –Ω–µ –∑–∞–¥–∞–Ω"
        exit 1
    fi
    
    echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π..."
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    timeout 60s npx prisma migrate deploy || {
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞ 60 —Å–µ–∫—É–Ω–¥"
        echo "üîÑ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—Ä—É—á–Ω—É—é"
        exit 1
    }
    
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client
    echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client..."
    npx prisma generate
    
    echo "‚úÖ Prisma Client —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
    
elif [ "$VERCEL_ENV" = "preview" ]; then
    echo "üîç Preview deployment - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏"
    
    # –¢–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è preview
    echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client –¥–ª—è preview..."
    npx prisma generate
    
else
    echo "üîß Development deployment - —Ç–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞"
    npx prisma generate
fi

echo "üéâ DEPLOYMENT –ú–ò–ì–†–ê–¶–ò–ô –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û!"