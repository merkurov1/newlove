# üìß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ä–∞—Å—Å—ã–ª–∫–æ–π (2025-11-09)

## üî¥ –ü—Ä–æ–±–ª–µ–º—ã

### 1. –†–∞—Å—Å—ã–ª–∫–∞ —É—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ 4-–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (–≤–º–µ—Å—Ç–æ 12)

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞ email –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ 4 –ø–æ–¥–ø–∏—Å—á–∏–∫–∞:

- ayellin@gmail.com
- makarluba@gmail.com
- 4104466@gmail.com
- anya11@bk.ru (–∏–ª–∏ vshimanovich@gmail.com)

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞: RATE LIMIT –æ—Ç Resend API** üö®

‚ùå **–ù–ï –ø—Ä–æ–±–ª–µ–º–∞ —Å isActive** - –≤ –±–∞–∑–µ 12 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, –≤—Å–µ –ø–æ–ª—É—á–∞—é—Ç `isActive=true`

‚úÖ **–ù–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** Resend API –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –ø–ª–∞–Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ **2 –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥—É**

Worker –ø—ã—Ç–∞–ª—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ 12 –ø–∏—Å–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:

- ‚úÖ –ü–µ—Ä–≤—ã–µ 2-4 –ø–∏—Å—å–º–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚ùå –û—Å—Ç–∞–ª—å–Ω—ã–µ 8 –ø–∏—Å–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã —Å –æ—à–∏–±–∫–æ–π `rate_limit_exceeded`

**–û—à–∏–±–∫–∞ –æ—Ç Resend:**

````json
{
  "name": "rate_limit_exceeded",
  "message": "Too many requests. You can only make 2 requests per second.",
  "statusCode": 429
}

–í –∫–æ–¥–µ `app/admin/actions.js` (—Å—Ç—Ä–æ–∫–∞ 1001):

```javascript
const { data: subs } = await supabase
  .from('subscribers')
  .select('id,email')
  .eq('isActive', true) // ‚Üê –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ!
  .limit(SEND_LIMIT);
````

**–ü–æ—á–µ–º—É isActive=false —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö?**

- –ü—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–µ—Ç—Å—è subscriber —Å `isActive=false`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è confirmation email —Å —Ç–æ–∫–µ–Ω–æ–º
- `isActive` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `true` —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –Ω–∞ —Å—Å—ã–ª–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª email ‚Üí `isActive=false` ‚Üí –ø–∏—Å—å–º–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–†–µ—à–µ–Ω–∏–µ:**
–≠—Ç–æ **–Ω–µ –±–∞–≥**, –∞ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** —Å–∏—Å—Ç–µ–º—ã (double opt-in –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞).

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º (–≤–∫–ª—é—á–∞—è –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö):

1. ‚ùå **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø** (–Ω–∞—Ä—É—à–∞–µ—Ç GDPR –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∂–∞–ª–æ–±–∞–º –Ω–∞ —Å–ø–∞–º)
2. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ confirmation email –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º

### 2. –ú–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –¥–≤–∞–∂–¥—ã

**–°–∏–º–ø—Ç–æ–º:**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É" –¥–≤–∞–∂–¥—ã
- –¢–µ –∂–µ —Å–∞–º—ã–µ 4 –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –ø–æ–ª—É—á–∏–ª–∏ –ø–∏—Å—å–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

1. –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ `isLoading` –≤ –∫–ª–∏–µ–Ω—Ç–µ (–º–æ–∂–Ω–æ –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å –¥–≤–∞–∂–¥—ã –±—ã—Å—Ç—Ä–æ)
2. –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `sentAt` –≤ —Å–µ—Ä–≤–µ—Ä–µ (–º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ)

**–†–µ—à–µ–Ω–∏–µ:**
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞:

#### A) –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ (`SendLetterForm.tsx`)

```typescript
async function handleSendLetter(formData) {
  // Prevent double-send if already loading
  if (isLoading) {
    console.warn('–û—Ç–ø—Ä–∞–≤–∫–∞ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫');
    return;
  }

  setIsLoading(true);
  // ... rest of code
}
```

#### B) –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞ (`app/admin/actions.js`)

```javascript
// Load letter with sentAt field
const { data: letter } = await supabase
  .from('letters')
  .select('id,title,slug,content,published,sentAt') // ‚Üê Added sentAt
  .eq('id', letterId)
  .maybeSingle();

// Prevent accidental re-sending
if (!testEmail && letter.sentAt) {
  return {
    status: 'error',
    message: `‚ùå –≠—Ç–∞ —Ä–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ${new Date(letter.sentAt).toLocaleString('ru-RU')}. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.`,
  };
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–µ—Å—Ç–æ–≤—ã–µ –ø–∏—Å—å–º–∞ (—Å —É–∫–∞–∑–∞–Ω–Ω—ã–º testEmail) –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ.

---

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. `app/api/cron/newsletter-worker/route.ts` ‚≠ê –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

**–ü—Ä–æ–±–ª–µ–º–∞:** Worker –æ—Ç–ø—Ä–∞–≤–ª—è–ª –≤—Å–µ –ø–∏—Å—å–º–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–∞—Ä—É—à–∞—è rate limit Resend (2 req/sec)

**–†–µ—à–µ–Ω–∏–µ:**

- –ò–∑–º–µ–Ω–µ–Ω —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—É—é —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `EMAIL_DELAY_MS = 600` (600ms –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏)
- –ò–∑–º–µ–Ω–µ–Ω —Ü–∏–∫–ª —Å `Promise.all(batch.map(...))` –Ω–∞ `for...of` —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

**–ö–æ–¥ –¥–æ:**

```typescript
const batchPromises = batch.map(async (subscriber) => {
  await sendNewsletterToSubscriber(...);
});
await Promise.all(batchPromises); // ‚ùå –í—Å–µ –ø–∏—Å—å–º–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
```

**–ö–æ–¥ –ø–æ—Å–ª–µ:**

```typescript
for (const subscriber of batch) {
  await sendNewsletterToSubscriber(...);
  await new Promise(resolve => setTimeout(resolve, EMAIL_DELAY_MS)); // ‚úÖ 600ms –∑–∞–¥–µ—Ä–∂–∫–∞
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~1.6 –ø–∏—Å–µ–º/—Å–µ–∫—É–Ω–¥—É (–ø–æ–¥ –ª–∏–º–∏—Ç–æ–º 2 req/sec)

### 2. `app/admin/actions.js`

**–°—Ç—Ä–æ–∫–∏:** 943-955 (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ sentAt)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `sentAt` –≤ SELECT –∑–∞–ø—Ä–æ—Å –ø–∏—Å—å–º–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–∏—Å—å–º–æ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (`sentAt` –Ω–µ null) ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∏—Å—å–º–∞ (testEmail) –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ

### 3. `components/admin/SendLetterForm.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

#### A) –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 13-18)

```typescript
if (isLoading) {
  console.warn('–û—Ç–ø—Ä–∞–≤–∫–∞ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫');
  return;
}
```

#### B) –£–ª—É—á—à–µ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ 108-120)

–î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏:

- ‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–∫—É –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å
- ‚úâÔ∏è –ü–∏—Å—å–º–∞ –∏–¥—É—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (isActive=true)
- üîí –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
- ‚ùå –ù–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–∞—Ç –ø–∏—Å—å–º–æ
- üö´ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
- üí° –°—Å—ã–ª–∫–∞ –Ω–∞ SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

### 3. –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

#### `migrations/2025-11-09_check_subscribers.sql`

SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤:

- –ü–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–º
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã subscribers
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞

#### `scripts/check_all_subscribers.js`

Node.js —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —á–µ—Ä–µ–∑ CLI:

```bash
node scripts/check_all_subscribers.js
```

–í—ã–≤–æ–¥–∏—Ç:

- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö (isActive=true)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö (isActive=false)
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö email —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–º

---

## üìã –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 1: SQL –∑–∞–ø—Ä–æ—Å (–≤ Supabase Dashboard)

```sql
SELECT
  email,
  "isActive",
  "createdAt",
  "userId"
FROM subscribers
ORDER BY "createdAt" DESC;
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Node.js —Å–∫—Ä–∏–ø—Ç

```bash
cd /workspaces/newlove
node scripts/check_all_subscribers.js
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (SQL —Ñ–∞–π–ª)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ñ–∞–π–ª–∞:

```
migrations/2025-11-09_check_subscribers.sql
```

---

## üîß –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º (–≤–∫–ª—é—á–∞—è –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö)

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:** –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (single opt-in):

- –ù–∞—Ä—É—à–∞–µ—Ç GDPR –∏ CAN-SPAM –∑–∞–∫–æ–Ω—ã
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∂–∞–ª–æ–±–∞–º –Ω–∞ —Å–ø–∞–º
- –ú–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ–º–µ–Ω –≤ Resend/–¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö

**–ï—Å–ª–∏ –≤—Å–µ –∂–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ (–¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ä–æ–π –±–∞–∑—ã):**

1. –í—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ `app/admin/actions.js` (—Å—Ç—Ä–æ–∫–∞ 1001):

```javascript
// TEMPORARY: Send to all subscribers (including unconfirmed)
const { data: subs } = await supabase
  .from('subscribers')
  .select('id,email')
  // .eq('isActive', true)  // ‚Üê –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
  .limit(SEND_LIMIT);
```

2. –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ** –ø—Ä–æ–≤–µ—Ä–∫—É `isActive`

3. –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç: –ú–∞—Å—Å–æ–≤–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤:

```sql
-- –û–ü–ê–°–ù–û! –í—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö email
UPDATE subscribers
SET "isActive" = true
WHERE email IN (
  'email1@example.com',
  'email2@example.com'
  -- ... —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö email
);
```

### –ö–∞–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å confirmation email –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º

```sql
-- –ù–∞–π—Ç–∏ –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
SELECT email, "createdAt"
FROM subscribers
WHERE "isActive" = false
ORDER BY "createdAt" DESC;
```

–ó–∞—Ç–µ–º –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ confirmation —Ç–æ–∫–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞).

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

### –í Resend Dashboard:

- –°–∫–æ–ª—å–∫–æ –ø–∏—Å–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
- –°–∫–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
- –°–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç–æ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω tracking)
- –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏

### –í –ª–æ–≥–∞—Ö Vercel:

```bash
# –ù–∞–π—Ç–∏ –ª–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
grep "Starting newsletter send" logs.txt
grep "newsletter job" logs.txt
```

### –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞
SELECT
  id,
  title,
  "sentAt",
  "createdAt"
FROM letters
WHERE "sentAt" IS NOT NULL
ORDER BY "sentAt" DESC
LIMIT 10;

-- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è newsletter_jobs
SELECT
  id,
  status,
  total_count,
  sent_count,
  created_at,
  completed_at
FROM newsletter_jobs
ORDER BY created_at DESC
LIMIT 10;
```

---

## üéØ –ò—Ç–æ–≥–∏

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ (–∫–ª–∏–µ–Ω—Ç)
2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å–µ—Ä–≤–µ—Ä)
3. –£–ª—É—á—à–µ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ —Ç–æ–º, –∫—Ç–æ –ø–æ–ª—É—á–∏—Ç –ø–∏—Å—å–º–∞
4. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

### ‚ÑπÔ∏è –ü–æ—è—Å–Ω–µ–Ω–æ:

- –ü–æ—á–µ–º—É –ø–∏—Å—å–º–∞ –∏–¥—É—Ç —Ç–æ–ª—å–∫–æ 4-–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (double opt-in —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
- –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

1. –î–æ–±–∞–≤–∏—Ç—å –≤ –∞–¥–º–∏–Ω–∫—É —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤"
3. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ confirmation email
4. –î–æ–±–∞–≤–∏—Ç—å bulk-–∞–∫—Ç–∏–≤–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
5. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É newsletter_logs

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã —Ä–∞—Å—Å—ã–ª–∫–∏

```
1. –ü–æ–¥–ø–∏—Å–∫–∞ ‚Üí subscribers (isActive=false)
2. Confirmation email ‚Üí subscriber_tokens (type='confirm')
3. –ö–ª–∏–∫ –Ω–∞ —Å—Å—ã–ª–∫—É ‚Üí /api/newsletter-confirm?token=xxx
4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è ‚Üí UPDATE subscribers SET isActive=true
5. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ ‚Üí SELECT * WHERE isActive=true
6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è unsubscribe token ‚Üí subscriber_tokens (type='unsubscribe')
7. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Resend ‚Üí emails.send()
8. –ü–æ–º–µ—Ç–∫–∞ –ø–∏—Å—å–º–∞ ‚Üí UPDATE letters SET sentAt=NOW()
```

### –í–∞–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

- `subscribers` - —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (id, email, isActive, userId, createdAt)
- `subscriber_tokens` - —Ç–æ–∫–µ–Ω—ã –¥–ª—è confirm/unsubscribe (subscriber_id, type, token, expires_at)
- `letters` - –ø–∏—Å—å–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ (id, title, content, published, sentAt)
- `newsletter_jobs` - –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è >100 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤)
- `newsletter_logs` - –ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

### Environment Variables:

- `RESEND_API_KEY` - –∫–ª—é—á Resend API
- `NEWSLETTER_SEND_LIMIT` - –ª–∏–º–∏—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (default: 100)
- `NEXT_PUBLIC_SITE_URL` - URL —Å–∞–π—Ç–∞ –¥–ª—è —Å—Å—ã–ª–æ–∫
- `NOREPLY_EMAIL` - email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (default: noreply@merkurov.love)
- `NOREPLY_DISPLAY` - –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (default: Anton Merkurov)

---

**–î–∞—Ç–∞:** 2025-11-09  
**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ—à–µ–Ω–æ
